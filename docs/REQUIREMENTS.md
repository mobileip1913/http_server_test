# 语音对话测试平台 - 需求文档

## 1. 项目概述

### 1.1 项目背景
专业的语音对话测试平台，用于测试语音交互系统的完整流程（STT → LLM → TTS），支持批量测试和单语音测试两种模式。

### 1.2 项目目标
- 提供可视化的Web测试界面
- 支持批量测试和单语音测试
- 提供完整的测试报告（PDF/CSV/JSON）
- 准确记录和计算各服务延迟
- 支持专业测试团队使用

## 2. 功能需求

### 2.1 批量测试功能

#### 2.1.1 测试类型支持
- **商品询问**：测试用户询问商品信息的场景
- **商品对比**：测试用户对比不同商品的场景
- **商品下单**：测试用户下单购买的场景

#### 2.1.2 测试文件管理
- 支持三种独立的文本文件（`inquiries.txt`, `compares.txt`, `orders.txt`）
- 支持组合文件（用 `---` 分隔三个部分）
- 支持单个文件指定类型（`--input <file> --type <type>`）
- 自动扫描音频文件（`inquiry_XXX.opus`, `compare_XXX.opus`, `order_XXX.opus`）
- 自动生成映射文件（`file_list.txt`）

#### 2.1.3 随机选择功能
- 支持设置测试数量（`test_count`）
- 从所有音频文件中随机选择指定数量的测试
- 三种类型平均分配，有余数随机分配
- 如果某种类型文件不足，从其他类型补充

#### 2.1.4 并发测试
- 支持多设备并发测试
- 可配置并发数（1-100）
- 支持多个设备SN
- 每个设备可创建多个连接

### 2.2 单语音测试功能

#### 2.2.1 文字输入
- 在Web界面输入测试文字
- 支持多行文本输入
- 实时显示输入状态

#### 2.2.2 自动TTS生成
- 输入文字后自动调用TTS服务生成音频
- 使用讯飞TTS API生成PCM格式
- 自动转换为Opus格式（使用ffmpeg）
- 生成临时音频文件供测试使用

#### 2.2.3 测试执行
- 使用生成的音频文件执行测试
- 实时显示测试状态
- 显示STT识别结果
- 显示LLM回复内容
- 显示性能指标

#### 2.2.4 结果展示
- 在模态框中显示测试结果
- 显示性能指标（STT/LLM/TTS延迟、端到端延迟）
- 自动添加到实时对话流面板

### 2.3 测试报告功能

#### 2.3.1 PDF报告
- 测试信息和环境信息
- 总体统计（总测试数、成功/失败数、成功率、吞吐量）
- 各类型测试统计（询问、对比、下单）
- 性能指标统计（平均值、中位数、P95、P99、最小值、最大值）
- 失败分析和失败用例详情（前20个）

#### 2.3.2 CSV报告
- 完整的测试数据表格
- 测试信息和环境信息
- 总体统计和性能指标
- 失败分析
- **详细测试用例列表**（每个测试的完整信息）：
  - 测试ID、时间戳、类型、索引、状态
  - 请求文本、STT文本、LLM文本
  - 音频文件、连接ID、设备SN
  - STT/LLM/TTS延迟、端到端响应时间
  - 失败原因、错误信息
  - 发送/接收消息数和字节数
- 使用UTF-8 BOM编码，Excel可正确打开

#### 2.3.3 JSON报告
- 完整的测试结果数据（JSON格式）
- 包含所有PDF和CSV报告中的数据
- 完整的测试用例列表
- 导出元数据（导出时间、格式、版本）
- 便于程序化分析和集成

### 2.4 性能指标需求

#### 2.4.1 时间戳记录
必须准确记录以下时间点（使用毫秒时间戳）：
1. **send_time**：发送第一帧音频前记录
2. **stt_response_time**：收到STT响应时记录
3. **llm_response_time**：收到LLM响应时记录
4. **tts_start_time**：收到TTS start消息时记录
5. **tts_stop_time**：收到TTS stop消息时记录

#### 2.4.2 延迟计算
必须准确计算以下延迟（单位：毫秒）：
1. **STT服务延迟** = stt_response_time - send_time
   - 从发送音频到收到STT结果的时间
   - 包含网络传输和STT处理时间

2. **LLM服务延迟** = llm_response_time - stt_response_time
   - 从STT完成到LLM响应的时间
   - LLM处理时间

3. **TTS服务延迟** = tts_start_time - llm_response_time
   - 从LLM完成到TTS开始的时间
   - TTS服务启动延迟

4. **端到端响应时间** = tts_stop_time - send_time
   - 从发送音频到收到完整TTS响应的时间
   - 完整的用户体验时间

#### 2.4.3 延迟统计
对每个延迟指标提供：
- 平均值（avg）
- 中位数（median）
- P95分位数
- P99分位数
- 最小值（min）
- 最大值（max）
- 样本数（count）

### 2.5 TTS音频生成工具

#### 2.5.1 单个音频生成（generate_tts_audio.py）
- 支持命令行参数指定文本
- 支持生成Opus格式（默认）
- 支持生成MP3格式（`--mp3`）
- 自动调用讯飞TTS API
- 自动转换为Opus格式（PCM → Opus）

#### 2.5.2 批量音频生成（generate_batch_tts.py）
- 支持三种独立文件模式
- 支持组合文件模式（`---` 分隔）
- 支持单个文件指定类型（`--input <file> --type <type>`）
- 支持强制重新生成（`--force`）
- 自动跳过已存在的文件
- 自动生成映射文件

### 2.6 Web界面需求

#### 2.6.1 主界面
- 统计卡片（总测试数、成功、失败、成功率）
- 进度条（显示测试进度和Opus文件总数）
- 实时对话流面板
- 性能指标面板
- 测试结果面板

#### 2.6.2 设置功能
- 设备SN配置（每行一个）
- 并发数设置（1-100）
- 测试模式选择（正常模式/急速模式）
- 测试数量设置（可选，留空则测试所有文件）
- WebSocket服务器地址配置（可选）

#### 2.6.3 单语音测试界面
- 文字输入框
- 测试配置（设备SN、测试模式）
- 实时状态显示
- 性能指标显示
- 测试结果展示

#### 2.6.4 报告查看
- 报告模态框
- 实时报告数据展示
- 导出PDF/CSV/JSON按钮
- 报告始终可见（不隐藏）

## 3. 非功能需求

### 3.1 性能需求
- 支持并发测试（最多100个并发连接）
- 测试响应时间准确记录（毫秒级精度）
- 报告生成时间 < 5秒（1000个测试用例）

### 3.2 可靠性需求
- 确保每个对话完成后再进行下一个对话
- 准确识别测试完成状态
- 正确处理网络异常和超时

### 3.3 可用性需求
- Web界面响应式设计
- 支持横屏和竖屏模式
- 实时状态更新
- 清晰的错误提示

### 3.4 兼容性需求
- 支持Windows系统（主要）
- 支持Linux/Mac系统
- Python 3.8+
- 现代浏览器（Chrome、Firefox、Edge）

### 3.5 安全性需求
- API密钥存储在代码中（可配置为环境变量）
- 临时文件自动清理
- 测试数据不包含敏感信息

## 4. 技术约束

### 4.1 依赖要求
- **Python包**：websockets, flask, flask-socketio, flask-cors, reportlab, opuslib
- **系统工具**：FFmpeg（必须）
- **系统库**：opus.dll（Windows，已包含在libs/目录）

### 4.2 API依赖
- **讯飞TTS API**：用于生成测试音频
- **WebSocket服务器**：目标测试服务器

### 4.3 文件格式
- 音频格式：Opus（测试用）、MP3（播放测试用）
- 文本格式：UTF-8编码
- 报告格式：PDF、CSV（UTF-8 BOM）、JSON

## 5. 用户角色

### 5.1 测试工程师
- 配置测试参数
- 执行批量测试
- 执行单语音测试
- 查看测试报告
- 分析测试结果

### 5.2 测试团队
- 导出测试报告（PDF/CSV/JSON）
- 分析性能指标
- 识别问题用例
- 生成测试报告

## 6. 验收标准

### 6.1 功能验收
- ✅ 支持三种测试类型（询问、对比、下单）
- ✅ 支持批量测试和单语音测试
- ✅ 准确记录和计算所有延迟指标
- ✅ 生成完整的测试报告（PDF/CSV/JSON）
- ✅ 支持随机选择测试文件
- ✅ 支持并发测试

### 6.2 性能验收
- ✅ 延迟计算准确（毫秒级精度）
- ✅ 测试完成状态判断准确
- ✅ 报告生成时间 < 5秒

### 6.3 可用性验收
- ✅ Web界面响应式设计
- ✅ 实时状态更新
- ✅ 清晰的错误提示
- ✅ 报告始终可见

